#!/bin/sh
# Author: Demogorgon
# Inspired by or fork of mural.sh by slackjeff <slackjeff@riseup.net>
# Changelog:
# 03/04/2024 - Spelling correction - devnull (The POSIX Way Samurai)
# 13/11/2025 - ASCII banner, new menu, program renaming - Demogorgon
# 13/11/2025 - Protection against command injection / escape codes - Demogorgon

# Suggested requirements:
# Copy the graffiti shellscript program for all users to use
# cp graffiti /usr/local/bin/
# chmod +x /usr/local/bin/graffiti
# As root, create the message file and add an "enter" before the first entry, for standardized reading.

# touch /var/log/graffiti_wall.log && printf '\n' > /var/log/graffiti_wall.log 
# chmod 666 /var/log/graffiti_wall.log
# Optional:
# chattr +a /var/log/graffiti_wall.log (append-only mode)
# To edit: chattr -a /var/log/graffiti_wall.log

set -eu

PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
export PATH

oldstty=''
if command -v stty >/dev/null 2>&1; then
    oldstty=$(stty -g 2>/dev/null || printf '')
    stty -echoctl 2>/dev/null || :
fi

############### Variables ###############
dir='/var/log'
file='graffiti_wall.log'
logfile=$dir/$file

myNameIs=$(
    { id -un 2>/dev/null || printf 'unknown'; }
)
sanitizedUser=$(printf '%s' "$myNameIs" | tr -c '[:alnum:]_.-' '_')

: "${TMPDIR:=/tmp}"
tempFile="$TMPDIR/graffiti_${sanitizedUser}_$$"
: > "$tempFile" || {
    printf 'Error creating temporary file.\n' >&2
    exit 1
}

# ANSI colors (foreground)
black=$(printf '\033[30m')
red=$(printf '\033[31m')
green=$(printf '\033[32m')
yellow=$(printf '\033[33m')
blue=$(printf '\033[34m')
magenta=$(printf '\033[35m')
cyan=$(printf '\033[36m')
white=$(printf '\033[37m')

# Color variations with names outside the ANSI standard
brown=$(printf '\033[0;33m')        # dark yellow (ANSI brown)
orange=$(printf '\033[93m')         # bright yellow / orange
gray=$(printf '\033[90m')           # bright black / dark gray
light_gray=$(printf '\033[37m')     # white (often appears as light gray)
pink=$(printf '\033[95m')           # bright magenta / pink
purple=$(printf '\033[35m')         # magenta (dark purple)
violet=$(printf '\033[95m')         # bright magenta (light purple)
light_blue=$(printf '\033[94m')     # bright blue
dark_blue=$(printf '\033[34m')      # standard blue
light_green=$(printf '\033[92m')    # bright green
dark_green=$(printf '\033[32m')     # standard green
gold=$(printf '\033[1;33m')         # bold yellow / gold
beige=$(printf '\033[1;33m')        # beige-like (bold yellow)

# ANSI colors (foreground bright)
bright_black=$(printf '\033[90m')
bright_red=$(printf '\033[91m')
bright_green=$(printf '\033[92m')
bright_yellow=$(printf '\033[93m')
bright_blue=$(printf '\033[94m')
bright_magenta=$(printf '\033[95m')
bright_cyan=$(printf '\033[96m')
bright_white=$(printf '\033[97m')

# ANSI Colors (background)
bg_black=$(printf '\033[40m')
bg_red=$(printf '\033[41m')
bg_green=$(printf '\033[42m')
bg_yellow=$(printf '\033[43m')
bg_blue=$(printf '\033[44m')
bg_magenta=$(printf '\033[45m')
bg_cyan=$(printf '\033[46m')
bg_white=$(printf '\033[47m')

bg_bright_black=$(printf '\033[100m')
bg_bright_red=$(printf '\033[101m')
bg_bright_green=$(printf '\033[102m')
bg_bright_yellow=$(printf '\033[103m')
bg_bright_blue=$(printf '\033[104m')
bg_bright_magenta=$(printf '\033[105m')
bg_bright_cyan=$(printf '\033[106m')
bg_bright_white=$(printf '\033[107m')

# Attributes
reset=$(printf '\033[0m')
bold=$(printf '\033[1m')
underline=$(printf '\033[4m')

COLOR_VARS='black red green yellow blue magenta cyan white brown orange gray light_gray pink purple violet light_blue dark_blue light_green dark_green gold beige
bright_black bright_red bright_green bright_yellow bright_blue bright_magenta bright_cyan bright_white
bg_black bg_red bg_green bg_yellow bg_blue bg_magenta bg_cyan bg_white
bg_bright_black bg_bright_red bg_bright_green bg_bright_yellow bg_bright_blue bg_bright_magenta bg_bright_cyan bg_bright_white
reset bold underline'

############### Functions ###############

get_color_value() {
    case $1 in
        black)              printf '%s' "$black" ;;
        red)                printf '%s' "$red" ;;
        green)              printf '%s' "$green" ;;
        yellow)             printf '%s' "$yellow" ;;
        blue)               printf '%s' "$blue" ;;
        magenta)            printf '%s' "$magenta" ;;
        cyan)               printf '%s' "$cyan" ;;
        white)              printf '%s' "$white" ;;
        brown)              printf '%s' "$brown" ;;
        orange)             printf '%s' "$orange" ;;
        gray)               printf '%s' "$gray" ;;
        light_gray)         printf '%s' "$light_gray" ;;
        pink)               printf '%s' "$pink" ;;
        purple)             printf '%s' "$purple" ;;
        violet)             printf '%s' "$violet" ;;
        light_blue)         printf '%s' "$light_blue" ;;
        dark_blue)          printf '%s' "$dark_blue" ;;
        light_green)        printf '%s' "$light_green" ;;
        dark_green)         printf '%s' "$dark_green" ;;
        gold)               printf '%s' "$gold" ;;
        beige)              printf '%s' "$beige" ;;  
        bright_black)       printf '%s' "$bright_black" ;;
        bright_red)         printf '%s' "$bright_red" ;;
        bright_green)       printf '%s' "$bright_green" ;;
        bright_yellow)      printf '%s' "$bright_yellow" ;;
        bright_blue)        printf '%s' "$bright_blue" ;;
        bright_magenta)     printf '%s' "$bright_magenta" ;;
        bright_cyan)        printf '%s' "$bright_cyan" ;;
        bright_white)       printf '%s' "$bright_white" ;;
        bg_black)           printf '%s' "$bg_black" ;;
        bg_red)             printf '%s' "$bg_red" ;;
        bg_green)           printf '%s' "$bg_green" ;;
        bg_yellow)          printf '%s' "$bg_yellow" ;;
        bg_blue)            printf '%s' "$bg_blue" ;;
        bg_magenta)         printf '%s' "$bg_magenta" ;;
        bg_cyan)            printf '%s' "$bg_cyan" ;;
        bg_white)           printf '%s' "$bg_white" ;;
        bg_bright_black)    printf '%s' "$bg_bright_black" ;;
        bg_bright_red)      printf '%s' "$bg_bright_red" ;;
        bg_bright_green)    printf '%s' "$bg_bright_green" ;;
        bg_bright_yellow)   printf '%s' "$bg_bright_yellow" ;;
        bg_bright_blue)     printf '%s' "$bg_bright_blue" ;;
        bg_bright_magenta)  printf '%s' "$bg_bright_magenta" ;;
        bg_bright_cyan)     printf '%s' "$bg_bright_cyan" ;;
        bg_bright_white)    printf '%s' "$bg_bright_white" ;;
        reset)              printf '%s' "$reset" ;;
        bold)               printf '%s' "$bold" ;;
        underline)          printf '%s' "$underline" ;;
        *)                  return 1 ;;
    esac
    return 0
}

expand_colors_line() {
    # Receives a line in $1 and expands ${color} -> ANSI sequence
    line=$1
    expanded=$line

    for var in $COLOR_VARS; do
        value=$(get_color_value "$var" 2>/dev/null || printf '')
        [ -n "$value" ] || continue
        expanded=$(printf '%s' "$expanded" | sed "s|\${$var}|$value|g")
    done

    printf '%s\n' "$expanded"
}

usage() {
    prog=${0##*/}
    printf 'Use: %s [options]\n' "$prog"
    printf '\n'
    printf 'Options:\n'
    printf '  -h    Display this help message.\n'
    printf '  -c    Displays the ANSI codes for coloring the ASCII message or artwork.\n'
    printf '\n'
    printf 'Within the message, use markers such as ${green}, ${bright_green},\n'
    printf '${bg_white}, ${bg_bright_white}, ${bold}, ${underline} and ${reset}.\n'
    printf '\n'
}

show_ansi_palette() {
    printf 'Available ANSI codes:\n\n'
    printf 'Use ${color_name} before the text to change the color\n'
    printf 'and to interrupt the formatting use ${reset}.\n\n'
    for var in $COLOR_VARS; do
        value=$(get_color_value "$var" 2>/dev/null || printf '')
        [ -n "$value" ] || continue

        if [ "$var" = "underline" ]; then
            # It only underlines the word "underline", not the padding spaces.
            # "Underline" has 9 characters, so 17-8=9.
            printf '  %sunderline%s%-8s -> ${%s}\n' "$value" "$reset" '' "$var"
        else
            printf '  %s%-17s%s -> ${%s}\n' "$value" "$var" "$reset" "$var"
        fi

        printf '\n'
    done
}

CLEAR() {
    if [ -n "$oldstty" ] && command -v stty >/dev/null 2>&1; then
        stty "$oldstty" 2>/dev/null || :
    fi
    rm -f -- "$tempFile"
    exit 0
}

############### Tests ###############

if [ ! -f "$logfile" ]; then
    : > "$logfile"
    chmod 666 "$logfile"
fi

############### Trap global ###############

trap 'CLEAR' INT TERM HUP EXIT

############### Start ###############

# Handles command-line options (-h, -c)
if [ "$#" -gt 0 ]; then
    case $1 in
        -h|--help)
            usage
            exit 0
            ;;
        -c)
            show_ansi_palette
            exit 0
            ;;
        *)
            prog=${0##*/}
            printf "%s: Invalid option: %s\n" "$prog" "$1" >&2
            printf "Use \"%s -h\" for help.\n" "$prog" >&2
            exit 1
            ;;
    esac
fi

# Display current graffiti wall with expanded colors
if [ -s "$logfile" ]; then
    while IFS= read -r line; do
        expand_colors_line "$line"
    done < "$logfile"
fi

# ASCII Banner
printf ' %s   ___|               _|   _| _)  |   _) %s\n' "$white" "$reset"
printf ' %s  |       __|  _` |  |    |    |  __|  | %s\n' "$white" "$reset"
printf ' %s  |   |  |    (   |  __|  __|  |  |    | %s\n' "$white" "$reset"
printf ' %s \____| _|   \__,_| _|   _|   _| \__| _| %s\n' "$white" "$reset"
printf '\n'

printf '%s%s Write a message and <CTRL-D>. %s\n' "$gray" "$bg_green" "$reset"
printf '%s%s Or press <CTRL-C> to get out. %s\n' "$gray" "$bg_white" "$reset"
printf '\n'

# Reads the user's message until EOF (CTRL-D)
: >"$tempFile"
cat >"$tempFile"

if [ -s "$tempFile" ]; then
    # Header of the "graffiti"
    printf '[ %s%s%s tagged in %s ]\n\n' \
        "$bold" "$sanitizedUser" "$reset" "$(date)" >>"$logfile"

    # Sanitization:
    # 1) Remove ANSI sequences of the type ESC [ ... @-~ (arrows, Insert, Home, etc.)
    # 2) Remove control characters (includes backspace/DEL)
    esc=$(printf '\033')
    # Sanitization:
    # 1) Remove control characters (includes ESC, backspace/DEL, etc.)
    # 2) Removes arrow residue (such as [D, [C, [A, [B)
    sanitized=$(
        LC_ALL=C tr -d '\000-\010\013\014\016-\037\177' <"$tempFile" |
        sed 's/\[[0-9;]*[ABCD]//g'
    )
    # 'body' = all lines except the last one
    body=$(printf '%s\n' "$sanitized" | sed '$d')
    # 'last' = last line (to ensure ${reset} at the end)
    last=$(printf '%s\n' "$sanitized" | sed -n '$p')

    if [ -n "$body" ]; then
        printf '%s\n' "$body" >>"$logfile"
    fi

    if [ -n "$last" ]; then
        # Forces a ${reset} literal at the end of the last line.
        printf '%s%s\n' "$last" '${reset}' >>"$logfile"
    fi

    printf '\n' >>"$logfile"

    printf '\n0k, graffiti on the wall...\n'
    CLEAR
else
    printf 'Write something...\n'
    CLEAR
fi
